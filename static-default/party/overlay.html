<!DOCTYPE html>
<style>

body {
  font-family: system-ui;
  font-size: 14px;
}

#videoMutedEl, #audioMutedEl {
  color: red;
}

#preview {
  position: absolute;
  top: 0;
  right: 0;
  width: 15vw;
  object-fit: cover;
  border-bottom-right-radius: 1em;
  transform: scale(-1, 1);
}

#messages {
  margin: 0;
  padding: 0;
  list-style-type: none;

  color: #fff;
  font-family: Helvetica, Arial, sans-serif;
}

#newMessage { pointer-events: all; }

</style>
<div id=videoMutedEl style="display: none">Camera off</div>
<div id=audioMutedEl style="display: none">Microphone off</div>
<video muted id=preview></video>

<div id=chat>
  <ul id=messages></ul>
  <form action=# id=newMessage>
    <input type=text name=message>
    <button type=submit>â†‘</button>
  </form>
</div>

<script type=module>

import Service from '/space/js/Service.js'

Service.get('userMedia', userMedia => {
  userMedia.observe('videoMuted', videoMuted => {
    videoMutedEl.style.display = videoMuted ? '' : 'none';
  });
  userMedia.observe('audioMuted', audioMuted => {
    audioMutedEl.style.display = audioMuted ? '' : 'none';
  });
  userMedia.observe('stream', stream => {
    preview.srcObject = stream;
    preview.play();
  });
});

let whoami;
Service.get('room', room => whoami = room.whoami);

Service.get('chat', chat => {
  chat.observe('message', ({from, message}) => {
    const li = document.createElement('li');
    li.classList.add(from === chat.whoami ? 'self' : 'other');
    li.innerText = message;

    messages.appendChild(li);
  });

  newMessage.addEventListener('submit', (event) => {
    event.preventDefault();
    chat.addMessage(newMessage.message.value);
    newMessage.message.value = '';
  });
});

</script>
